# Отчёт о тестировании — баги для разработки

Дата: 2026-02-09  
Контекст: MVP платформы менторинга (progect.md). Проверены сценарии по UC, валидации, завершаемость сценариев, отображение ошибок.

---

## Критичные

### BUG-1. Профиль менти: в форме нет поля «Желаемая должность»

**Спецификация (UC-04, progect.md):** у менти поле «Желаемая должность — необязательно».

**Факт:** В форме профиля менти (`MenteeForm`) отображаются только «Цель или причина поиска ментора» и «Статус поиска». Поле `desiredPosition` в API и БД есть (backend: `UpdateMenteeDto`, `mentees.service.ts`; frontend: `shared/types/profile.ts`), но в UI его нет — пользователь не может указать желаемую должность.

**Где:** `frontend/src/features/profile/components/MenteeForm.tsx`

**Рекомендация:** Добавить необязательное поле «Желаемая должность» (input, maxLength 200), передавать в `useUpdateMenteeProfile` и синхронизировать state с `mentee.desiredPosition` (аналогично `goal` / `searchStatus`).

---

### BUG-2. После принятия заявки список «Связи» не обновляется

**Сценарий:** Ментор принимает заявку (на главной или на странице «Входящие заявки»). Ожидается, что раздел «Мои менти» / «Связи» сразу отражает новую связь.

**Факт:** В `useAcceptRequest` при успехе инвалидируются только `keys.incoming` и `['dashboard']`. Запрос списка связей (`['connections']`) не инвалидируется. Пользователь переходит в «Мои менти» и видит старый список до ручного обновления или перехода туда-обратно.

**Где:** `frontend/src/features/requests/hooks/useRequests.ts`, мутация `useAcceptRequest`

**Рекомендация:** В `onSuccess` мутации `useAcceptRequest` добавить:
`queryClient.invalidateQueries({ queryKey: ['connections'] });`

---

## Средний приоритет

### BUG-3. Регистрация: при незаполненной роли нет явной подсказки

**Сценарий:** Пользователь заполняет email и пароль, не выбирает роль и нажимает «Зарегистрироваться».

**Факт:** Кнопка в этот момент disabled (`disabled={!role}`), поэтому отправки нет. Но если бы кнопка была активна (или при ином способе отправки), пользователь не увидел бы сообщения вида «Выберите роль» — валидация только через `if (!role) return;` без установки ошибки в UI.

**Где:** `frontend/src/features/auth/components/RegisterForm.tsx`

**Рекомендация:** При `if (!role) return` выводить сообщение об ошибке (например, `setRoleError('Выберите роль')`) и отображать его над кнопкой или у блока выбора роли, чтобы сценарий был однозначным и соответствовал ожиданиям по валидации.

---

### BUG-4. Онбординг: при уже выбранной роли не показывается текущая роль

**Спецификация (UC-03):** при заходе на онбординг с уже выбранной ролью ожидается «показать текущую роль и переход в профиль» (или явное отображение роли).

**Факт:** При уже выбранной роли показывается экран «Дозаполнение профиля» с текстом «Роль уже выбрана при регистрации», но сама роль («Ментор» / «Менти») нигде не выводится. Пользователь не видит явного подтверждения «Ваша роль: Ментор».

**Где:** `frontend/src/features/profile/pages/OnboardingPage.tsx` (блок для `profile && hasRole && !isAdmin`)

**Рекомендация:** Добавить текст вида «Ваша роль: Ментор» или «Ваша роль: Менти» в заголовок или подзаголовок экрана дозаполнения профиля.

---

### BUG-5. Профиль ментора: нет клиентской проверки максимума активных менти

**Спецификация:** максимальное количество активных менти — число от 0 до 100.

**Факт:** В форме ментора поле «Максимальное количество активных менти» имеет `type="number"` и атрибуты `min={0}` и `max={100}`. Ввод значения > 100 возможен (в части браузеров ограничение по max не жёсткое). Backend при значении > 100 вернёт 400 с сообщением валидации, но пользователь не получает мгновенной подсказки на форме.

**Где:** `frontend/src/features/profile/components/MentorForm.tsx`

**Рекомендация:** В `runValidation` добавить проверку: если `num > 100`, устанавливать `errors.maxMentees = 'Максимум 100'`. Дополнительно можно ограничить ввод на onChange (например, `Math.min(100, value)`).

---

### BUG-6. Страница «Избранное» доступна без проверки роли до запроса

**Сценарий:** Пользователь с профилем, но без выбранной роли (аномалия или переход по прямой ссылке), открывает `/favorites`.

**Факт:** Маршрут `/favorites` защищён только `ProtectedRoute`, без `ProfileGuard` и без проверки роли. Запрос к API избранного выполняется (`useFavorites(true)`), для пользователя без роли менти бэкенд возвращает 403. Пользователь видит сообщение «Доступно только для пользователей с ролью «Менти»» только после загрузки и ошибки.

**Где:** `frontend/src/app/routes/index.tsx` (маршрут `favorites`), `frontend/src/features/favorites/pages/FavoritesPage.tsx`

**Рекомендация:** Либо обернуть маршрут в проверку роли (аналогично RoleGuard для менти) и при отсутствии роли редиректить на `/profile` или `/onboarding`, либо на странице до вызова `useFavorites` проверять наличие роли менти и не делать запрос (enabled: false), показывая сразу сообщение о необходимости роли.

---

## Низкий приоритет / улучшения

### BUG-7. Единая кнопка «Сохранить профиль»: ошибки только в блоках форм

**Сценарий:** На странице профиля в режиме редактирования пользователь нажимает «Сохранить профиль» (общая кнопка). Одна из форм (общие данные / ментор / менти) возвращает ошибку с бэкенда.

**Факт:** Ошибка отображается в соответствующей форме через `ErrorMessage` внутри каждой формы. Если форма не в зоне видимости (например, менторская форма ниже), пользователь может не заметить сообщение об ошибке.

**Где:** `frontend/src/features/profile/pages/ProfilePage.tsx`, формы с `hideSubmitButton`

**Рекомендация:** Рассмотреть вывод общей ошибки сохранения рядом с кнопкой «Сохранить профиль» (например, из ref или из общего state после submit), чтобы ошибка была видна без прокрутки.

---

### BUG-8. Связи: после открепления статус в карточке

**Сценарий:** На странице «Мои менти» / «Мои менторы» отображаются связи со статусом ACTIVE и DETACHED.

**Факт:** В карточке для `conn.status === 'DETACHED'` выводится текст с `conn.completedAt` и `conn.detachedAt`. Если связь откреплена до завершения менторства, `completedAt` может быть null; формулировка «Завершено ранее · ...» в таком случае может вводить в заблуждение.

**Где:** `frontend/src/features/connections/pages/ConnectionsPage.tsx` (блок для `conn.status === 'DETACHED'`)

**Рекомендация:** Уточнить текст: для DETACHED без completedAt показывать только «Связь прекращена» и дату открепления; для DETACHED с completedAt — «Завершено ранее» и при необходимости «Связь прекращена».

---

## Что проверено и работает корректно

- **Валидация backend:** DTO (профиль, ментор, менти, заявка, открепление) с сообщениями на русском; ValidationPipe с whitelist/forbidNonWhitelisted.
- **Ошибки API:** Единый формат через HttpExceptionFilter (message, code); фронт извлекает сообщение через `getErrorMessage` (в т.ч. массив message).
- **Профиль/формы:** ProfileForm, MentorForm, MenteeForm синхронизируют state с пропами через useEffect при изменении profile/mentor/mentee (в т.ч. после сохранения).
- **Аватар:** При размере файла > 500 KB показывается сообщение «Файл слишком большой. Максимум 500 KB» (AvatarUpload).
- **Темы специализации ментора:** Backend требует минимум один тег (`@ArrayMinSize(1)` в UpdateMentorDto); фронт проверяет «Укажите хотя бы один тег».
- **Заявки:** Валидация длины сопроводительного письма (10–2000), отображение ошибок (в т.ч. «Заявка уже отправлена», «У ментора достигнут лимит активных менти»).
- **Роли и доступ:** RoleGuard редиректит на /profile при отсутствии нужной роли; страницы входящих/исходящих заявок и формы заявки доступны по роли.
- **Избранное:** Ошибки добавления/удаления отображаются; при 403 на странице избранного показывается сообщение о роли «Менти».

---

## Итоговая таблица

| ID     | Краткое описание                                              | Приоритет   |
|--------|---------------------------------------------------------------|------------|
| BUG-1  | В форме менти отсутствует поле «Желаемая должность»           | Критичный   |
| BUG-2  | После принятия заявки не инвалидируется кэш списка «Связи»    | Критичный   |
| BUG-3  | Регистрация: нет явной подсказки при незаполненной роли       | Средний     |
| BUG-4  | Онбординг: не отображается текущая роль при уже выбранной     | Средний     |
| BUG-5  | Профиль ментора: нет клиентской валидации maxMentees ≤ 100    | Средний     |
| BUG-6  | Избранное: запрос выполняется без проверки роли до 403        | Средний     |
| BUG-7  | Ошибки сохранения профиля только внутри форм                   | Низкий      |
| BUG-8  | Текст статуса откреплённой связи без завершения               | Низкий      |

Рекомендуется в первую очередь исправить BUG-1 и BUG-2, затем — BUG-3–BUG-6 по возможностям.
