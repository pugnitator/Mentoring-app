# Этап 6: Connections & Detachment (UC-11) — Постановка задачи для разработчика

## Цель этапа

Реализовать просмотр активных связей «ментор–менти» и открепление (отвязку). Прикрепление уже реализовано в этапе 5 (создание Connection при принятии заявки). В этапе 6: список связей для текущего пользователя, открепление любой стороной с необязательной причиной, скрытие контактов после открепления, email-уведомление второй стороне об отвязке.

## Use Case (из [progect.md](progect.md))

- **UC-11. Прикрепление и открепление**
  - Прикрепление происходит автоматически при принятии заявки (реализовано в этапе 5).
  - Открепление может инициировать **любая сторона** (ментор или менти).
  - Причина — **необязательная**.
  - После открепления **контакты скрываются**.

## Контекст проекта

- В [backend/prisma/schema.prisma](backend/prisma/schema.prisma) уже есть модель **Connection** (id, mentorId, menteeId, requestId, status ACTIVE | DETACHED, createdAt, detachedAt?, reason?). Связь создаётся в [requests.service](backend/src/modules/requests/requests.service.ts) при accept.
- Модуля **connections** в backend нет; маршрута `/connections` на фронте нет.
- Нефункциональные требования ([progect.md](progect.md), разд. 7–9): REST, JSON, JWT, ответ API ≤ 500 мс, защита от XSS/CSRF/SQL-инъекций, единый формат ошибок, язык — русский, responsive web.

---

# Часть 1. Функциональные требования

## 1.1. Backend: схема данных

- Модель **Connection** уже содержит все нужные поля: status, detachedAt, reason. Изменения схемы не требуются.
- Логика «скрытие контактов»: при статусе DETACHED в ответах API не возвращать контактные данные второй стороны (email, имя/фамилия из профиля); возвращать только факт связи и, при необходимости, дату открепления и причину.

## 1.2. Backend: модуль Connections

**Структура:** `backend/src/modules/connections/`

**Сервис (connections.service.ts)**

- **findAllForCurrentUser(userId):** список связей, в которых пользователь участвует (как ментор или как менти).
  - По userId определить Profile и наличие mentor и/или mentee (в MVP одна роль — либо mentor, либо mentee).
  - Выбрать Connection где mentorId = текущий ментор ИЛИ menteeId = текущий менти. Включить связь со второй стороной (mentor.profile.user, mentee.profile) для отображения имени и контакта.
  - **Правило контактов:** для записей со status ACTIVE возвращать контактные данные второй стороны (email пользователя, имя, фамилия из Profile). Для status DETACHED контактные данные **не возвращать** (поля пустые или не включать в ответ).
  - Сортировка по createdAt desc. Можно возвращать только ACTIVE для страницы «Активные связи» или все с пометкой статуса — в постановке зафиксировать: **возвращать все связи** (ACTIVE и DETACHED), но контакты только для ACTIVE.
- **detach(userId, connectionId):** открепление.
  - Проверить, что Connection с connectionId существует и что текущий пользователь — либо ментор, либо менти этой связи. Иначе 404.
  - Проверить, что status === ACTIVE. Иначе 400 «Связь уже откреплена».
  - Обновить Connection: status = DETACHED, detachedAt = now(), reason = body.reason (опционально).
  - Отправить email второй стороне (если ментор инициировал отвязку — уведомить менти; если менти — уведомить ментора). Текст на русском: например «Связь с [имя] была прекращена. [Причина при наличии].»
  - Вернуть обновлённую связь (без контактов второй стороны, т.к. уже DETACHED).

**Контроллер (connections.controller.ts)**

- Все маршруты под **JwtAuthGuard**.
- `GET /api/connections` — список связей текущего пользователя. 200 + массив. Каждый элемент: id, mentorId, menteeId, requestId, status, createdAt, detachedAt?, reason?; для второй стороны при ACTIVE — контакт (email, firstName, lastName и т.д.), при DETACHED — без контакта.
- `POST /api/connections/:id/detach` — открепиться. Body: DetachDto (reason?: string). 200 + обновлённая связь. 404 если связь не найдена или не принадлежит пользователю; 400 если уже DETACHED.

**DTO**

- DetachDto: reason (string, optional, max length например 500). Валидация class-validator; сообщения на русском.

**Регистрация:** ConnectionsModule в AppModule.

## 1.3. Кто может вызывать API

- GET /api/connections: пользователь, у которого есть роль **ментор** или **менти** (есть profile.mentor или profile.mentee). Если ни того ни другого — 403 «Доступ запрещён» или пустой массив — на усмотрение; рекомендуется 200 и пустой массив для единообразия.
- POST /api/connections/:id/detach: только участник этой связи (ментор или менти). Иначе 404 (не раскрывать существование связи чужому пользователю).

## 1.4. Email при откреплении

- Использовать существующий [notifications/mail.service](backend/src/modules/notifications/mail.service.ts). После обновления Connection отправить письмо второй стороне (User.email ментора или менти). Шаблон: связь прекращена, инициатор (не обязательно раскрывать), причина если указана. Отправка асинхронная (не блокировать ответ API).

## 1.5. Frontend: функциональные требования

**Маршрут**

- `/connections` — страница «Мои связи» (или «Активные связи»). Доступна авторизованным пользователям с ролью ментор или менти.

**Страница «Мои связи»**

- Заголовок, например «Мои связи» или «Активные связи».
- Запрос GET /api/connections. Отображение списка связей.
- Для каждой связи со статусом ACTIVE: карточка с данными второй стороны (имя, фамилия, email — для связи с менти показывать контакт менти, для связи с ментором — контакт ментора) и кнопка «Открепиться» / «Прекратить связь».
- Для связей со статусом DETACHED: по желанию показывать в отдельном блоке «История» без контактов (только дата открепления и причина если есть) или не показывать — в постановке зафиксировать: **показывать только ACTIVE** на основной странице; при необходимости отдельная вкладка/секция «История откреплений» с записями без контактов.
- При клике «Открепиться»: открыть форму/модальное окно с необязательным полем «Причина» (textarea) и кнопкой «Подтвердить». Отправка POST /api/connections/:id/detach с body { reason }. После успеха — обновить список (инвалидировать запрос), убрать карточку из активных или обновить её статус.
- Если связей нет: сообщение «У вас пока нет активных связей» и ссылка на каталог менторов или на заявки.

**Навигация**

- В главном меню добавить пункт «Мои связи» со ссылкой на `/connections`. Показывать авторизованным пользователям (ментор и менти).

**Дополнительно**

- На странице входящих заявок (этап 5) после принятия заявки можно показывать ссылку «Перейти к связям» на `/connections`, чтобы ментор видел контакт менти в одном месте.

---

# Часть 2. Нефункциональные требования

## 2.1. Производительность

- **Время ответа API:** GET /api/connections и POST /api/connections/:id/detach укладываются в **500 мс** (в рамках общих NFR проекта). Список связей — один запрос с include (profile, user для контактов); без N+1.
- **Email:** отправка письма об отвязке не блокирует ответ; выполнять после возврата ответа клиенту. При ошибке SMTP — только логирование.

## 2.2. Безопасность

- **Авторизация:** оба эндпоинта только с JWT. Проверка принадлежности связи: при detach разрешать действие только если текущий userId соответствует mentor или mentee этой связи (через profile.mentor.id / profile.mentee.id).
- **Скрытие контактов:** в ответах API и в UI для связей со статусом DETACHED не возвращать и не отображать email и персональные данные второй стороны. Это требование UC-11 («после открепления контакты скрываются»).
- **Валидация:** DTO reason — ограничение длины, при необходимости санитизация (запрет скриптов/HTML). Защита от SQL-инъекций — через Prisma.

## 2.3. Надёжность и целостность

- **Идемпотентность:** повторный POST detach для уже DETACHED связи возвращать 200 с текущим состоянием или 400 «Связь уже откреплена» — единообразно с остальным API.
- **Транзакции:** обновление Connection (status, detachedAt, reason) — одна операция; отдельная отправка email после успешного обновления.

## 2.4. Контракты и совместимость

- **Формат:** REST, JSON. Единый формат ошибок (statusCode, code, message, timestamp, path).
- **Язык:** все сообщения пользователю и текст письма об отвязке — **на русском**.

## 2.5. Frontend: нефункциональные

- **Адаптивность:** страница `/connections` корректно отображается на мобильных и планшетах (responsive).
- **Обработка ошибок:** отображение ошибок API через общий механизм (например, getErrorMessage); при 403/404 — понятные сообщения на русском.
- **Доступность:** кнопки и форма причины доступны с клавиатуры; подписи к полям и кнопкам понятны.

---

# Часть 3. API-контракты (сводка)


| Метод | URL                         | Кто                   | Описание                                                                                                                 |
| ----- | --------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| GET   | /api/connections            | JWT, ментор или менти | Список связей текущего пользователя. Для ACTIVE — с контактом второй стороны; для DETACHED — без контакта. 200 + массив. |
| POST  | /api/connections/:id/detach | JWT, участник связи   | Body: { reason?: string }. Открепление. 200 + обновлённая связь. 404 связь не найдена/не своя; 400 уже DETACHED.         |


Формат элемента списка (пример): id, mentorId, menteeId, requestId, status, createdAt, detachedAt?, reason?; при status ACTIVE — объект contact (email, firstName, lastName) второй стороны; при DETACHED поле contact отсутствует или null.

---

# Часть 4. Критерии приёмки

**Функциональные**

- Ментор и менти видят свои активные связи на странице `/connections` с контактными данными второй стороны.
- Любая сторона может открепиться (POST detach); указывается необязательная причина.
- После открепления статус связи DETACHED; в ответах API и в UI контакты второй стороны не отображаются.
- Второй стороне отправляется email об отвязке (при настроенном SMTP).
- В навигации есть пункт «Мои связи»; форма открепления с полем «Причина» и подтверждением работает.

**Нефункциональные**

- Ответы API в пределах 500 мс; без N+1 при выдаче списка связей.
- Проверка JWT и принадлежности связи при detach; контакты для DETACHED не возвращаются.
- Единый формат ошибок, сообщения на русском; валидация DTO.
- Адаптивная вёрстка страницы; корректная обработка ошибок на клиенте.

---

# Часть 5. Зависимости и границы этапа

- **Этап 5 (Requests):** выполнен; Connection создаётся при accept. В этапе 6 добавляются только модуль connections, эндпоинты списка и отвязки, скрытие контактов для DETACHED и email.
- **Этап 8 (Уведомления):** настройка «отключить уведомления» и шаблоны писем — этап 8; на этапе 6 достаточно одного типа письма «отвязка» и отправки при наличии SMTP.