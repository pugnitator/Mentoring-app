# Этап 7: Admin Panel (UC-13) — Постановка задачи для разработчика

## Цель этапа

Реализовать админ-панель: управление справочниками (теги и специальности) и просмотр пользователей. Доступ только для пользователей с ролью ADMIN. Помимо UC-13 (теги + просмотр пользователей) в объём этапа входит управление списком специальностей.

## Use Case (из [progect.md](progect.md))

- **UC-13. Администрирование**
  - Управление тегами (создание / редактирование / удаление)
  - Просмотр пользователей
- **Дополнение к этапу:** управление специальностями (создание / редактирование / удаление). Специальности используются в профиле пользователя и в фильтрах каталога менторов.

## Контекст проекта

- В [backend/prisma/schema.prisma](backend/prisma/schema.prisma): User (поле role: USER | ADMIN), Profile (поле specialty — строка), Tag уже есть. Справочника специальностей в БД нет; на фронте используется константа [SPECIALTIES](frontend/src/features/profile/constants/specialties.ts).
- Публичный [GET /api/tags](backend/src/modules/tags/tags.controller.ts) уже есть; CRUD тегов для админа в отдельном модуле admin.
- Роль пользователя хранится в User.role; отдельного RoleGuard для ADMIN в проекте пока нет — его нужно ввести в рамках этапа 7.

---

# Часть 1. Функциональные требования

## 1.1. Backend: проверка прав администратора

- **RolesGuard:** создать guard, проверяющий наличие в `request.user` поля `role === 'ADMIN'`. Если JWT стратегия не кладёт role в user — дополнить payload и метод validate в [jwt.strategy](backend/src/modules/auth/strategies/jwt.strategy.ts), чтобы в request.user был объект с полями id, email, role (из User).
- **Декоратор @Roles:** например `@Roles('ADMIN')`, использовать вместе с RolesGuard. При отсутствии роли ADMIN возвращать **403 Forbidden** с сообщением на русском («Доступ запрещён. Требуется роль администратора.»).
- Все маршруты под префиксом `/api/admin/*` защищать JwtAuthGuard + RolesGuard (только ADMIN).

## 1.2. Backend: схема данных для специальностей

**Файл:** [backend/prisma/schema.prisma](backend/prisma/schema.prisma)

- Добавить модель **Specialty**:
  - `id` String @id @default(uuid())
  - `name` String @unique (название специальности, например «Frontend-разработчик»)
  - `sortOrder` Int? (опционально, для порядка вывода в списках)
  - `createdAt` DateTime @default(now())
- **Profile:** поле `specialty` оставить строкой. Справочник Specialty — источник допустимых значений: при сохранении профиля (profiles.service) проверять, что `dto.specialty` совпадает с одним из `Specialty.name`, либо не валидировать жёстко (тогда справочник только для выбора в UI). Рекомендация: **не менять тип Profile.specialty** на этапе 7; справочник Specialty используется для списка в формах и фильтрах; при удалении специальности админом проверять, что ни один Profile.specialty не равен этой записи — иначе запрещать удаление (409).
- Миграция: `npx prisma migrate dev --name add_specialties`. После миграции выполнить seed или скрипт: создать записи Specialty из текущего константного списка [SPECIALTIES](frontend/src/features/profile/constants/specialties.ts), чтобы данные в БД и на фронте совпадали.

## 1.3. Backend: модуль Admin

**Структура:** `backend/src/modules/admin/`

**Управление тегами (админские эндпоинты)**

- `GET /api/admin/tags` — список всех тегов (id, name, description, createdAt). Только ADMIN.
- `POST /api/admin/tags` — создание тега. Body: { name, description? }. Валидация: name не пустой, уникальность. 201 + созданный тег.
- `PATCH /api/admin/tags/:id` — обновление тега. Body: { name?, description? }. 200 + тег. 404 если тег не найден.
- `DELETE /api/admin/tags/:id` — удаление тега. 204 No Content. Если тег используется в MentorTag — 409 «Невозможно удалить: тег привязан к менторам» (или удалять связи — зафиксировать в постановке: **запрет удаления при наличии связей**).

**Управление специальностями**

- `GET /api/admin/specialties` — список всех специальностей (id, name, sortOrder, createdAt). Только ADMIN.
- `POST /api/admin/specialties` — создание. Body: { name, sortOrder? }. Валидация: name не пустой, уникальность. 201 + созданная запись.
- `PATCH /api/admin/specialties/:id` — обновление. Body: { name?, sortOrder? }. 200 + запись. 404 если не найдена.
- `DELETE /api/admin/specialties/:id` — удаление. 204. Если хотя бы один Profile.specialty совпадает с именем этой специальности — 409 «Невозможно удалить: специальность используется в профилях».

**Публичный список специальностей для форм и фильтров**

- Оставить или добавить **публичный** `GET /api/specialties` (без префикса admin): возвращает список специальностей (id, name, sortOrder) для выбора в форме профиля и в фильтре каталога. Реализация в модуле admin или в отдельном specialties controller — на усмотрение; важно, что эндпоинт доступен без роли ADMIN.

**Просмотр пользователей**

- `GET /api/admin/users` — список пользователей. Только ADMIN. Параметры: пагинация (page, limit), опционально фильтр по role, status, поиск по email. Ответ: массив с полями id, email, role, status, createdAt и при необходимости данные профиля (firstName, lastName, specialty) для отображения в таблице. Без выдачи паролей и чувствительных данных.

**Регистрация:** AdminModule в AppModule. Модуль admin импортирует PrismaService; при необходимости использует существующие сервисы Tags (для логики тегов) или дублирует минимальную логику в admin.service.

## 1.4. Frontend: админ-панель

**Доступ**

- Маршруты под префиксом `/admin` (например `/admin`, `/admin/tags`, `/admin/specialties`, `/admin/users`). Защита: при отсутствии JWT редирект на логин; при роли не ADMIN — 403 или редирект с сообщением «Доступ запрещён». Роль пользователя можно получать из текущего профиля/токена (если бэкенд отдаёт role в ответе логина/профиля — использовать это).

**Общая структура**

- Страница-оболочка `/admin`: боковое меню или табы — «Теги», «Специальности», «Пользователи». Контент по выбранному пункту.
- **Страница «Теги»** (`/admin/tags`): таблица/список тегов (название, описание). Кнопки «Добавить», «Изменить», «Удалить». Форма создания/редактирования (модальное окно или отдельная форма): название, описание. При удалении — подтверждение; при 409 показывать сообщение от API.
- **Страница «Специальности»** (`/admin/specialties`): таблица/список (название, порядок). Кнопки «Добавить», «Изменить», «Удалить». Форма: название, порядок (число). При удалении — подтверждение; при 409 показывать сообщение.
- **Страница «Пользователи»** (`/admin/users`): таблица (email, роль, статус, дата регистрации, при необходимости имя/фамилия, специальность). Пагинация. Опционально: фильтр по роли, статусу, поиск по email.

**Интеграция справочника специальностей в приложении**

- Форма профиля и фильтр каталога менторов должны использовать **список специальностей из API** (GET /api/specialties), а не константу из кода. После внедрения справочника: загружать варианты при открытии формы/каталога; сохранять в профиле выбранное название (Profile.specialty остаётся строкой). При первом запуске после этапа 7 убедиться, что в БД есть записи Specialty (seed), иначе список будет пустым.

**Навигация**

- Пункт «Админ-панель» в главном меню показывать **только пользователям с ролью ADMIN** (если роль известна на клиенте). Ссылка ведёт на `/admin`.

---

# Часть 2. Нефункциональные требования

## 2.1. Безопасность

- Все эндпоинты `/api/admin/*` доступны только с JWT и ролью ADMIN. Проверка на бэкенде обязательна; не полагаться только на скрытие кнопок на фронте.
- Не возвращать в ответах админки чувствительные данные (хеши паролей, внутренние ID, если не нужны). Список пользователей — только поля, необходимые для просмотра (email, role, status, профиль для отображения).

## 2.2. Производительность

- Время ответа API админки укладывается в **500 мс** (NFR проекта). Списки тегов, специальностей и пользователей — без N+1; пагинация для users при большом объёме данных.

## 2.3. Валидация и целостность

- При удалении тега: проверка на наличие связей MentorTag; при наличии — 409, не удалять. При удалении специальности: проверка на использование в Profile.specialty (сравнение по имени); при наличии — 409.
- DTO для создания/обновления тегов и специальностей: class-validator, сообщения на русском. Уникальность name проверять на бэкенде.

## 2.4. Контракты и язык

- REST, JSON. Единый формат ошибок (statusCode, code, message, ...). Все сообщения пользователю и ошибки — **на русском**.

## 2.5. Frontend

- Админ-панель адаптивна (responsive). Обработка ошибок через общий механизм; при 403 — понятное сообщение. Формы доступны с клавиатуры.

---

# Часть 3. API-контракты (сводка)


| Метод  | URL                        | Доступ            | Описание                                                       |
| ------ | -------------------------- | ----------------- | -------------------------------------------------------------- |
| GET    | /api/admin/tags            | JWT, ADMIN        | Список тегов.                                                  |
| POST   | /api/admin/tags            | JWT, ADMIN        | Создание тега. Body: { name, description? }.                   |
| PATCH  | /api/admin/tags/:id        | JWT, ADMIN        | Обновление тега.                                               |
| DELETE | /api/admin/tags/:id        | JWT, ADMIN        | Удаление. 409 если тег используется.                           |
| GET    | /api/admin/specialties     | JWT, ADMIN        | Список специальностей.                                         |
| POST   | /api/admin/specialties     | JWT, ADMIN        | Создание. Body: { name, sortOrder? }.                          |
| PATCH  | /api/admin/specialties/:id | JWT, ADMIN        | Обновление.                                                    |
| DELETE | /api/admin/specialties/:id | JWT, ADMIN        | Удаление. 409 если используется в профилях.                    |
| GET    | /api/admin/users           | JWT, ADMIN        | Список пользователей (пагинация, фильтры).                     |
| GET    | /api/specialties           | Публичный или JWT | Список специальностей для форм/фильтров (id, name, sortOrder). |


---

# Часть 4. Критерии приёмки

**Функциональные**

- Только пользователь с ролью ADMIN может открыть админ-панель и вызывать API /api/admin/*; иначе 403.
- Админ может создавать, редактировать и удалять теги; при удалении используемого тега возвращается 409.
- Админ может создавать, редактировать и удалять специальности; при удалении используемой специальности возвращается 409.
- Админ видит список пользователей с пагинацией (и при необходимости фильтрами).
- Форма профиля и фильтр каталога используют список специальностей из GET /api/specialties.
- В БД есть модель Specialty; seed заполняет начальный список специальностей.

**Нефункциональные**

- RolesGuard и декоратор @Roles применяются ко всем админским эндпоинтам; JWT содержит role.
- Ответы API в пределах 500 мс; валидация DTO; сообщения на русском; единый формат ошибок.
- Адаптивный UI админки; корректная обработка 403 и 409 на клиенте.