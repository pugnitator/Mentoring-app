# Отчёт QA: Этап 2 — User Profile & Role Selection (UC-03, UC-04)

Проведена проверка реализации по спецификации из `plans/2-User_Profile_and_Role_Selection.md`. Ниже — найденные баги и замечания для исправления.

---

## Критичные баги

### BUG-1. Backend: темы специализации ментора можно сохранить пустыми

**Спецификация (п. «Обязательность полей»):** темы специализации — обязательно.

**Факт:** В `UpdateMentorDto` поле `specializationTopics` проверяется только как массив строк (`@IsArray`, `@IsString` each), ограничения на минимальное количество элементов нет. На фронте можно отправить пустой массив (например, оставить поле «Темы специализации» пустым и нажать «Сохранить»), backend возвращает 200, в БД сохраняется пустой массив.

**Где:** `backend/src/modules/mentors/dto/update-mentor.dto.ts`

**Рекомендация:** Добавить валидацию «минимум одна тема», например `@ArrayMinSize(1, { message: 'Укажите хотя бы одну тему специализации' })` для `specializationTopics`, и при необходимости проверку на непустые строки после trim.

---

### BUG-2. Frontend: при выборе слишком большого файла аватара пользователь не видит сообщение об ошибке

**Спецификация (граничные случаи):** аватар вне лимита → 400 (и ожидаемо понятная реакция в UI).

**Факт:** В `AvatarUpload` при размере файла > 500 KB вызывается только `uploadAvatar.reset()`, запрос на сервер не отправляется. Ни toast, ни текст под кнопкой, ни `ErrorMessage` не показываются. Пользователь не понимает, почему ничего не произошло.

**Где:** `frontend/src/features/profile/components/AvatarUpload.tsx`

**Рекомендация:** При `file.size > MAX_SIZE_BYTES` показывать сообщение пользователю (например, состояние «Файл слишком большой. Максимум 500 KB» под кнопкой или через общий механизм уведомлений). Не сбрасывать ошибку молча.

---

### BUG-3. Frontend: формы профиля не обновляются после сохранения и при смене данных с сервера

**Спецификация:** редактирование профиля → «Сохранить» → обновление Profile / Mentor / Mentee.

**Факт:** В `ProfileForm`, `MentorForm`, `MenteeForm` начальные значения полей задаются через `useState(profile.xxx)` / `useState(mentor.xxx)` только при первом монтировании. После успешного сохранения вызывается `invalidateQueries`, данные с сервера подтягиваются, но локальный state в формах не синхронизируется с новым `profile`/`mentor`/`mentee`. В результате:
- после сохранения форма может продолжать показывать старые значения до перезагрузки или ухода со страницы;
- при навигации «профиль → другая страница → профиль» форма может отображать устаревшие данные, если проп `profile` обновился, а state — нет.

**Где:**  
`frontend/src/features/profile/components/ProfileForm.tsx`  
`frontend/src/features/profile/components/MentorForm.tsx`  
`frontend/src/features/profile/components/MenteeForm.tsx`

**Рекомендация:** Синхронизировать локальный state с входящими пропами (например, через `useEffect` при изменении `profile`/`mentor`/`mentee`) или пересоздавать форму при смене данных (например, `key={profile.updatedAt}` или `key={profile.id + profile.updatedAt}`), чтобы поля всегда соответствовали актуальным данным с сервера.

---

## Средний приоритет

### BUG-4. Спецификация: при заходе на /onboarding с уже выбранной ролью ожидается «показать текущую роль и переход в профиль»

**Спецификация (UC-03, сценарий «Роль уже выбрана»):**  
«Ожидаемый результат: Показать текущую роль и переход в профиль».

**Факт:** При уже выбранной роли пользователь сразу редиректится на `/profile`. Отдельный экран с текстом вида «Ваша роль: Ментор» и кнопкой «Перейти в профиль» не показывается.

**Где:** `frontend/src/app/routes/ProfileGuard.tsx` (редирект при `profile && hasRole && path === '/onboarding'`), при необходимости — отдельный экран или вариант страницы `/onboarding` для «роль уже выбрана».

**Рекомендация:** Уточнить у заказчика/аналитика: допустим ли только редирект или нужно явно показывать текущую роль на экране. Если нужно показывать — реализовать экран (или состояние на `/onboarding`) с отображением текущей роли и переходом в профиль.

---

### BUG-5. Аномалия: при профиле без роли (нет Mentor и Mentee) на /profile нельзя выбрать роль

**Спецификация:** нет профиля → заход на `/profile` → редирект на `/onboarding`.

**Факт:** Редирект выполняется только когда `!profile`. Если по какой-то причине у пользователя есть `Profile`, но нет ни `Mentor`, ни `Mentee` (аномалия БД или старые данные), он попадает на `/profile`, но блоки выбора роли там нет. Отображаются только общие поля и аватар, перейти к выбору роли нельзя.

**Где:** `frontend/src/features/profile/pages/ProfilePage.tsx`, логика редиректа в `ProfileGuard` и/или условный показ блока выбора роли на странице профиля.

**Рекомендация:** Либо при `profile && !profile.mentor && !profile.mentee` редиректить на `/onboarding`, либо на странице профиля в этом случае показывать блок «Выберите роль» (как на онбординге) и не показывать формы ментора/менти до выбора роли.

---

## Низкий приоритет / код

### BUG-6. Неиспользуемый импорт в ProfilesService

**Факт:** В `backend/src/modules/profiles/profiles.service.ts` импортируется `BadRequestException`, но нигде не используется.

**Рекомендация:** Удалить импорт `BadRequestException` из файла.

---

## Итог

| ID      | Краткое описание                                           | Приоритет   |
|---------|------------------------------------------------------------|------------|
| BUG-1   | Backend: пустой массив тем специализации принимается       | Критичный   |
| BUG-2   | Frontend: нет сообщения при аватаре > 500 KB               | Критичный   |
| BUG-3   | Frontend: формы не синхронизируются с данными после сохранения | Критичный   |
| BUG-4   | Не показывается текущая роль при заходе на /onboarding     | Средний     |
| BUG-5   | Профиль без роли: нельзя выбрать роль на /profile          | Средний     |
| BUG-6   | Лишний импорт BadRequestException в ProfilesService        | Низкий      |

Рекомендуется в первую очередь исправить BUG-1, BUG-2 и BUG-3, затем — BUG-4 и BUG-5 по согласованию с требованиями.
